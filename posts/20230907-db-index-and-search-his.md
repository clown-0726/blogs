# 数据库索引与查找结构进化

> 发布日期：2023-09-07 14:19:33

在业务上，选择用技术规避问题而不是相信别人的保证！

<img src="https://s1.ax1x.com/2023/09/10/pPcczND.md.png" style="zoom:0%;" />



## 概述

数据库索引是一种数据结构，用于快速查找和访问数据库中的数据。它类似于书籍的索引，可以帮助数据库系统快速定位和检索数据，而无需遍历整个数据集。

索引是数据库的灵魂，如果没有索引，数据库的数据检索将变得非常困难，数据也就失去了其使用的价值。

然而，索引并非没有代价的。创建索引需要占用额外的存储空间，并且在插入、更新和删除数据时需要维护索引的一致性，这可能会导致一些性能开销。因此，在创建索引时需要权衡查询性能和数据修改的频率。

常见的数据库索引类型包括 B 树索引、哈希索引、全文索引等。每种索引类型都有其适用的场景和特点，但是大多数场景下 B+ 树是最常见的索引类型。

#### 索引的优缺点

索引的优点主要有两点：

- 提高数据的检索的速度。
- 减少磁盘 IO 的次数。

在数据检索的时候，磁盘 IO 是非常昂贵的资源，减少磁盘 IO 的次数能有效的提高数据获得效率。

同样，索引的缺点也主要有两点：

- 索引会占据额外的存储空间。
- 插入、更新和删除数据时需要维护索引的一致性，这可能会导致一些性能开销。

#### 昂贵的磁盘 IO

磁盘 IO 时间 = 寻道 + 磁盘旋转 + 数据传输时间

从磁盘读取数据时，系统会将逻辑地址发给磁盘，磁盘将逻辑地址转换为物理地址（哪个磁道，哪个扇区）。磁头进行机械运动，先找到相应磁道，再找该磁道的对应扇区，扇区是磁盘的最小存储单元。

<img src="https://s1.ax1x.com/2023/09/10/pPcc078.md.jpg" style="zoom:75%;" />

机械硬盘的连续读写性能很好，但随机读写性能很差。

- 顺序访问：内存访问速度是梗盘访问速度 6-7 倍
- 随机访问：内存访问速度就要比硬盘访问速度快 10 万倍以上

随机读写时，磁头需要不停的移动，时间都浪费在了磁头寻址上。而在实际的磁盘存储里，是很少顺序存储的。因此在数据检索的时候尽量减少磁盘 IO 的次数，会对检索效率起到质的提高。

现在的 SSD 的顺序访问和机械硬盘其实没有太大差别，但是随机读取有了质的提高，这也能有效的提高数据检索效率。

参考：https://zhuanlan.zhihu.com/p/152291597

## 查找机构进化

索引的背后其实就是一种数据结构的使用，不同的数据结构适用于不同的的场景。对于数据库来说，B+ 树是一种最通用的索引数据结构，为什么这种数据结构被众多数据库索引所广泛使用，这可以从最简单的查找思想谈起。

对于数据库来说，索引的查找目标主要有下面几个：

- 支持等值查询
- 支持范围查询
- 支持 group by
- 支持 order by

#### 线性查找

线性查找是一种最简单的查找方式，也就是每个元素依次查找。线性查找不要求数据是有序的，其查找的时间复杂度是 O(1)。

很明显，这种最原始的查找方式类似于我们一页一页的从字典中查询一个字，效率是极低的。

从索引的目标来看：

- 等值查询：支持，但是效率很低；
- 范围查询：由于不要求元素是有序的，因此不支持；
- group by：不支持；
- order by：不支持；

#### Hash 表

Hash 表是常见的数据结构之一。Hash 表的 key 可以存储索引列，value 可以存储记录或者磁盘地址。Hash 表在等值查询时效率很高，时间复杂度为 O(1)。

- 但是不支持范围查找，范围查找只能通过全表扫描的方式实现；
- 数据结构比较稀疏，不适合做聚合；

#### 二叉查找树（BST）

如下图，一组元素根据插入的顺序不通，可以生成很多种二叉查找树。

对于一颗二叉树而言，每个节点最多有两个分支，左子树和右子树数据顺序做小右大。二叉树的检索复杂度和树的高度相关，其理想状态下可以达到 O(log(n)) 的时间复杂度，比如下图的第一棵树。

基于上述的特点，二叉查找树无法存储大规模的数据，如果树过高，对磁盘的读写会大量增加。

同时，二叉查找树存在复杂度退化问题（如果插入的数据是有序的，则会退化成线性查找问题）； 

<img src="https://s1.ax1x.com/2023/09/10/pPccrtg.md.png" style="zoom:0%;" />

从索引的目标来看：

- 等值查询：支持，理想情况下效率比较高，但存在复杂度退化问题；
- 范围查询：不支持；
- group by：不支持；
- order by：支持；虽然是有序的，随着树的高度增加，效率会很低；

#### 二叉平衡树（红黑树）

红黑树是一个近似平衡的二叉树。

平衡二叉树采用二分法思维，平衡二叉树除了具备二叉树的特点，最主要的特征是树的两个左右子树的层级最多相差 1。在插入/删除数据时，通过左旋/右旋操作保持二叉树的平衡。

使用平衡二叉树查询的性能接近于二分查找，时间复杂度是 O(log(2n))。

<img src="https://s1.ax1x.com/2023/09/10/pPccDAS.png" style="zoom:0%;" />

平衡二又树存在的问题：

时间复杂度和树高相关：树有多高就需要检索多少次，每个节点的读取，都对应一次磁盘 IO 操作。

- 磁盘每次寻道时间为 10ms，在表数据量大时，对响应时间要求高的场景下，查询性能就会出现瓶颈。

平衡二叉树不支持范围查询快速查找，范围查询时需要从根节点多次遍历，查询效率极差。

平衡二叉树本质上还是二叉树，数据量大的情況下，索引存储空间占用巨大。

实例：

假设一个简单的索引构成，<ID，行号，指针>，存储 10 亿数据。

- key 的大小是 bigint 为 8 byte，每个节点有两个指针，每个指针式 4 byte，那么一个节点的占用空间为 16 byte，最终索引大小为 10亿 * 16 byte = 15 G
- 在时间复杂度为 O(log(n)) 的情况下，最多不超过 30 次磁盘 IO 可以查询到数据。

#### B 树

B 树是一种改进的二叉树，是一棵多叉树。IO 读取次数减少是提高索引效率的关键要素之一，这样就要尽量降低树的高度。每个节点存储多个元素，每个节点可以存储 1000 个索引（16k/16=1000），这样就将二叉树改造成了多叉树，树的高度也相应的减少。

比如存储 1 百万数据，树的高度只需要两层就够了（1000*1000=1 百万），也就是只需要 2 次磁盘 IO 就可以查询到数据。磁盘 IO 的次数变少了，查询数据的效率也就提高了。

<img src="https://s1.ax1x.com/2023/09/12/pPg6Tuq.png" style="zoom:60%;" />

B 树的主要特点：

- B 树的节点中存储着多个元素，每个内节点有多个分叉；
- 节点中的元素包含键值和数据， 节点中的健值从大到小排序。也就是说，所有的节点都存数据；
- 父节点当中的元素不会出现在子节点中。
- 所有的叶子节点都位于同一层，叶节点具有相同的深度，叶节点之间没有指针连接。

优点：

- 因为 B 树树高比较低，磁盘 IO 次数会大大减少；
- 比较是在内存中进行的，比较的耗时可以忽路不计；
- B 树的高度一般 2 至 3 层就能满足大部分的应用场景，所以使用 B 树构建索可以很好的提升直询的效率；

缺点：

- B 树不支持范围查询的快速查找：范围查询每次需要回到根节点重新遍历查找，需要从根节点进行多次遍历，查询效率不是很高。
- 空间占用较大：如果 data 存储的是行记录，行的大小随着列数的增多，所占空间会变大。一个页中可存储的数据量就会变少，树相应就会变高，磁盘 IO 次数就会变大。

#### B+ 树

B+ 树式在 B 树基础上的改进和增强。B+ 树和 B 树最主要的区别在于：

- B 树：非叶子节点和叶子节点都会存储数据。
- B+ 树：只有叶子节点才会存储数据，非叶子节点只存储键值。叶子节点之间使用双向指针连接，最底层的叶子节点形成了一个双向有序链表。

B+ 树的最底层叶子节点包含所有素引项，具备中路返回特性。

<img src="https://s1.ax1x.com/2023/09/12/pPg6Ivn.png" style="zoom:50%;" />

从索引的目标来看：

- 等值查询：支持，和 B 树一样，可以效率比较高的查询到目标结点；
- 范围查询：支持，由于其所有数据都存储在叶子结点，叶子结点是双向链表，不需要返回根节点就可以进行范围查询；
- group by：支持；
- order by：支持；其叶子节点是有序的，很方便的进行排序操作；

## 参考文档
[1] 搭载固态硬盘的服务器究竟比搭机械硬盘快多少？ https://zhuanlan.zhihu.com/p/152291597 

[2] 机械硬盘内部原理：磁头是如何读写数据的？内部构造十分精密 https://www.bilibili.com/video/BV1R8411c7uZ/
